#!/bin/bash
# horizon-hook-copilot - GitHub Copilot CLI hook script for Horizon time tracking
#
# This script sends interaction events to the Horizon API for time tracking.
# It reads configuration from ~/.config/horizon/config.json.
#
# Usage: horizon-hook-copilot <event_type>
#   event_type: session-start or session-end
#
# Note: We intentionally avoid set -euo pipefail to ensure the script always
# exits 0, preventing blocking of Copilot CLI execution.

CONFIG_FILE="$HOME/.config/horizon/config.json"
LOG_FILE="$HOME/.config/horizon/error.log"
DEBUG_LOG_FILE="$HOME/.config/horizon/hook.log"
EVENT_TYPE="${1:-session-start}"

# Ensure config directory exists with secure permissions
mkdir -p "$(dirname "$LOG_FILE")"
chmod 700 "$(dirname "$LOG_FILE")" 2>/dev/null

# Ensure log files have secure permissions
touch "$LOG_FILE" "$DEBUG_LOG_FILE" 2>/dev/null
chmod 600 "$LOG_FILE" "$DEBUG_LOG_FILE" 2>/dev/null

# Check for required dependencies
if ! command -v jq &> /dev/null; then
    echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) - [copilot] jq is required but not installed" >> "$LOG_FILE" 2>/dev/null
    exit 0
fi

log_error() {
    echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) - [copilot] $1" >> "$LOG_FILE"
}

log_debug() {
    echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) - [copilot] $1" >> "$DEBUG_LOG_FILE"
}

log_debug "Hook invoked: event_type=$EVENT_TYPE"

# Clean up stale session files older than 24 hours (prevents accumulation from crashed sessions)
find /tmp -maxdepth 1 -name "horizon-copilot-session-*" -type f -mmin +1440 -delete 2>/dev/null || true

# For Copilot, we need to persist session ID across hook invocations
# (session-start and session-end run as separate processes with different PIDs)
# Use a temp file in /tmp keyed by working directory to share session ID between events
# The working directory uniquely identifies the Copilot session context
SESSION_DIR_HASH=$(pwd | shasum | cut -c1-16)
SESSION_FILE="/tmp/horizon-copilot-session-$SESSION_DIR_HASH"

if [[ "$EVENT_TYPE" == "session-start" ]]; then
    # Generate new session ID and persist it
    SESSION_ID="copilot-$(date +%s)-$RANDOM"
    echo "$SESSION_ID" > "$SESSION_FILE"
    log_debug "Created new session ID: $SESSION_ID (file: $SESSION_FILE)"
elif [[ "$EVENT_TYPE" == "session-end" ]]; then
    # Reuse session ID from session-start
    if [[ -f "$SESSION_FILE" ]]; then
        SESSION_ID=$(cat "$SESSION_FILE")
        rm -f "$SESSION_FILE"  # Clean up session file
        log_debug "Reused session ID: $SESSION_ID"
    else
        # Fallback if session file not found
        SESSION_ID="copilot-$(date +%s)-$RANDOM"
        log_debug "Session file not found, generated fallback ID: $SESSION_ID"
    fi
else
    # Unknown event type fallback
    SESSION_ID="copilot-$(date +%s)-$RANDOM"
    log_debug "Unknown event type, generated ID: $SESSION_ID"
fi

# Read config
if [[ ! -f "$CONFIG_FILE" ]]; then
    log_error "Config file not found: $CONFIG_FILE"
    exit 0
fi

API_URL=$(jq -r '.api_url // empty' "$CONFIG_FILE" 2>/dev/null)
API_KEY=$(jq -r '.api_key // empty' "$CONFIG_FILE" 2>/dev/null)

if [[ -z "$API_URL" || -z "$API_KEY" ]]; then
    log_error "Missing api_url or api_key in config"
    exit 0
fi

# Determine project name from git remote URL, fallback to directory name
PROJECT=""
if git rev-parse --git-dir > /dev/null 2>&1; then
    REMOTE_URL=$(git remote get-url origin 2>/dev/null || true)
    if [[ -n "$REMOTE_URL" ]]; then
        # Extract repo name from git URL (handles both SSH and HTTPS formats)
        PROJECT=$(echo "$REMOTE_URL" | sed -E 's/.*[\/:]([^\/]+)(\.git)?$/\1/' | sed 's/\.git$//')
    fi
fi

if [[ -z "$PROJECT" ]]; then
    PROJECT=$(basename "$(pwd)")
fi

# Normalize project name: lowercase, hyphens for special chars
PROJECT=$(echo "$PROJECT" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')

# Fallback if normalization resulted in empty string
if [[ -z "$PROJECT" ]]; then
    PROJECT="unknown-project"
    log_error "Project name normalized to empty string, using fallback: $PROJECT"
fi

log_debug "Project detected: $PROJECT"

# Map Copilot events to Horizon events
# session-start -> prompt-start
# session-end -> response-end
HORIZON_EVENT=""
case "$EVENT_TYPE" in
    session-start)
        HORIZON_EVENT="prompt-start"
        ;;
    session-end)
        HORIZON_EVENT="response-end"
        ;;
    *)
        log_error "Unknown event type: $EVENT_TYPE"
        exit 0
        ;;
esac

# Build payload
TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
MACHINE=$(hostname -s 2>/dev/null || hostname 2>/dev/null || echo "unknown")
AGENT="copilot-cli"

PAYLOAD=$(jq -n \
    --arg project "$PROJECT" \
    --arg timestamp "$TIMESTAMP" \
    --arg machine "$MACHINE" \
    --arg agent "$AGENT" \
    --arg session_id "$SESSION_ID" \
    --arg event_type "$HORIZON_EVENT" \
    '{project: $project, timestamp: $timestamp, machine: $machine, agent: $agent, session_id: $session_id, event_type: $event_type}')

# Send to API (5-second timeout, silent failure)
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
    -X POST "$API_URL/api/interactions" \
    -H "x-api-key: $API_KEY" \
    -H "Content-Type: application/json" \
    -d "$PAYLOAD" \
    --max-time 5 \
    2>/dev/null) || HTTP_CODE="000"

if [[ "$HTTP_CODE" != "201" && "$HTTP_CODE" != "200" ]]; then
    log_error "API request failed with HTTP $HTTP_CODE for project=$PROJECT session=$SESSION_ID event=$HORIZON_EVENT"
    log_debug "API request failed: HTTP $HTTP_CODE (mapped $EVENT_TYPE -> $HORIZON_EVENT)"
else
    log_debug "API request successful: HTTP $HTTP_CODE (mapped $EVENT_TYPE -> $HORIZON_EVENT)"
fi

# Always exit 0 regardless of API failures
exit 0

#!/bin/bash
# horizon-hook-kiro - Kiro CLI hook script for Horizon time tracking
#
# This script sends interaction events to the Horizon API for time tracking.
# It reads configuration from ~/.config/horizon/config.json and extracts
# context from environment variables provided by Kiro.
#
# Usage: horizon-hook-kiro <event_type>
#   event_type: agent-spawn, prompt-start, response-end, or session-end
#
# Note: We intentionally avoid set -euo pipefail to ensure the script always
# exits 0, preventing blocking of Kiro CLI execution.

CONFIG_FILE="$HOME/.config/horizon/config.json"
LOG_FILE="$HOME/.config/horizon/error.log"
DEBUG_LOG_FILE="$HOME/.config/horizon/hook.log"
SESSION_FILE="$HOME/.config/horizon/kiro-session"
EVENT_TYPE="${1:-prompt-start}"

# Ensure config directory exists with secure permissions
mkdir -p "$(dirname "$LOG_FILE")"
chmod 700 "$(dirname "$LOG_FILE")" 2>/dev/null

# Ensure log files have secure permissions
touch "$LOG_FILE" "$DEBUG_LOG_FILE" 2>/dev/null
chmod 600 "$LOG_FILE" "$DEBUG_LOG_FILE" 2>/dev/null

# Check for required dependencies
if ! command -v jq &> /dev/null; then
    echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) - [kiro] jq is required but not installed" >> "$LOG_FILE" 2>/dev/null
    exit 0
fi

log_error() {
    echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) - [kiro] $1" >> "$LOG_FILE"
}

log_debug() {
    echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) - [kiro] $1" >> "$DEBUG_LOG_FILE"
}

log_debug "Hook invoked: event_type=$EVENT_TYPE"

# Session ID management:
# - On prompt-start: generate a new session ID and save it to file
# - On response-end: read the session ID from file
# - On session-end: read the session ID from file and delete it
SESSION_ID=""

case "$EVENT_TYPE" in
    prompt-start|userPromptSubmit)
        # Generate new session ID and persist it
        SESSION_ID="kiro-$(date +%s)-$$-$RANDOM"
        echo "$SESSION_ID" > "$SESSION_FILE"
        chmod 600 "$SESSION_FILE" 2>/dev/null
        ;;
    response-end|stop|session-end)
        # Read existing session ID from file
        if [[ -f "$SESSION_FILE" ]]; then
            SESSION_ID=$(cat "$SESSION_FILE")
        fi
        # If session-end, clean up the file
        if [[ "$EVENT_TYPE" == "session-end" ]]; then
            rm -f "$SESSION_FILE"
        fi
        ;;
esac

# Fallback if no session ID available
if [[ -z "$SESSION_ID" ]]; then
    SESSION_ID="kiro-orphan-$(date +%s)-$$"
    log_debug "No session file found, using fallback session ID"
fi

log_debug "Session ID: $SESSION_ID"

# Read config
if [[ ! -f "$CONFIG_FILE" ]]; then
    log_error "Config file not found: $CONFIG_FILE"
    exit 0
fi

API_URL=$(jq -r '.api_url // empty' "$CONFIG_FILE" 2>/dev/null)
API_KEY=$(jq -r '.api_key // empty' "$CONFIG_FILE" 2>/dev/null)

if [[ -z "$API_URL" || -z "$API_KEY" ]]; then
    log_error "Missing api_url or api_key in config"
    exit 0
fi

# Determine project name from git remote URL, fallback to directory name
PROJECT=""
if git rev-parse --git-dir > /dev/null 2>&1; then
    REMOTE_URL=$(git remote get-url origin 2>/dev/null || true)
    if [[ -n "$REMOTE_URL" ]]; then
        # Extract repo name from git URL (handles both SSH and HTTPS formats)
        PROJECT=$(echo "$REMOTE_URL" | sed -E 's/.*[\/:]([^\/]+)(\.git)?$/\1/' | sed 's/\.git$//')
    fi
fi

if [[ -z "$PROJECT" ]]; then
    PROJECT=$(basename "$(pwd)")
fi

# Normalize project name: lowercase, hyphens for special chars
PROJECT=$(echo "$PROJECT" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')

# Fallback if normalization resulted in empty string
if [[ -z "$PROJECT" ]]; then
    PROJECT="unknown-project"
    log_error "Project name normalized to empty string, using fallback: $PROJECT"
fi

log_debug "Project detected: $PROJECT"

# Map Kiro events to Horizon events
# agent-spawn -> (skip, not a coding event)
# prompt-start -> prompt-start
# response-end -> response-end
# session-end -> session-end
# stop -> response-end
HORIZON_EVENT=""
case "$EVENT_TYPE" in
    agent-spawn)
        # Skip agent spawn events as they're not direct coding interactions
        log_debug "Skipping agent-spawn event"
        exit 0
        ;;
    prompt-start|userPromptSubmit)
        HORIZON_EVENT="prompt-start"
        ;;
    response-end)
        HORIZON_EVENT="response-end"
        ;;
    stop)
        HORIZON_EVENT="response-end"
        ;;
    session-end)
        HORIZON_EVENT="session-end"
        ;;
    *)
        log_error "Unknown event type: $EVENT_TYPE"
        log_debug "Unknown event type, exiting"
        exit 0
        ;;
esac

log_debug "Mapped $EVENT_TYPE -> $HORIZON_EVENT"

# Build payload
TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
MACHINE=$(hostname -s 2>/dev/null || hostname 2>/dev/null || echo "unknown")
AGENT="kiro-cli"

PAYLOAD=$(jq -n \
    --arg project "$PROJECT" \
    --arg timestamp "$TIMESTAMP" \
    --arg machine "$MACHINE" \
    --arg agent "$AGENT" \
    --arg session_id "$SESSION_ID" \
    --arg event_type "$HORIZON_EVENT" \
    '{project: $project, timestamp: $timestamp, machine: $machine, agent: $agent, session_id: $session_id, event_type: $event_type}')

# Send to API (5-second timeout, silent failure)
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
    -X POST "$API_URL/api/interactions" \
    -H "x-api-key: $API_KEY" \
    -H "Content-Type: application/json" \
    -d "$PAYLOAD" \
    --max-time 5 \
    2>/dev/null) || HTTP_CODE="000"

if [[ "$HTTP_CODE" != "201" && "$HTTP_CODE" != "200" ]]; then
    log_error "API request failed with HTTP $HTTP_CODE for project=$PROJECT session=$SESSION_ID event=$HORIZON_EVENT"
    log_debug "API request failed: HTTP $HTTP_CODE"
else
    log_debug "API request successful: HTTP $HTTP_CODE"
fi

# Always exit 0 regardless of API failures
exit 0
